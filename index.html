<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>JS Drum Machine</title>
        <link rel="stylesheet" href="style.css" />
        <!-- fonts -->
        <!-- <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Oxanium:wght@700&display=swap"
            rel="stylesheet"
        /> -->
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Oxanium:wght@200;600;700;800&display=swap"
            rel="stylesheet"
        />
        <link rel="stylesheet" href="./mega-walkthrough/mega-walkthrough.css" />
    </head>
    <body>
        <div class="mega-drum-machine">
            <header>
                <span class="title">BeatMachine</span>
                by <span class="signature">megaDoug</span>
            </header>
            <main>
                <div id="help-icon" data-mega-step="0">?</div>
                <div id="drumpad">
                    <div id="sliders">
                        <div class="slidecontainer" data-mega-step="7">
                            <div class="info tempo">
                                <label for="tempo-slider">TEMPO</label>
                                <span class="value">125</span>
                            </div>
                            <input
                                id="tempo-slider"
                                type="range"
                                min="50"
                                max="200"
                                value="125"
                                class="slider"
                            />
                        </div>
                        <div class="slidecontainer" data-mega-step="8">
                            <div class="info measure">
                                <label for="measures-slider">MEASURES</label>
                                <span class="value">2</span>
                            </div>

                            <input
                                id="measures-slider"
                                type="range"
                                min="1"
                                max="4"
                                value="2"
                                class="slider"
                            />
                        </div>
                    </div>
                    <div id="lights">
                        <div
                            id="beat-light"
                            class="light"
                            data-mega-step="2"
                        ></div>
                        <div id="rec-light" class="light" data-mega-step="3">
                            R
                        </div>
                        <div id="clear-light" class="light" data-mega-step="4">
                            X
                        </div>
                        <div
                            id="quantize-light"
                            class="light"
                            data-mega-step="5"
                        >
                            Q
                        </div>
                        <div
                            id="edit-light"
                            class="light rect"
                            data-mega-step="6"
                        >
                            Edit
                        </div>
                    </div>

                    <div id="keys" data-mega-step="1">
                        <div class="key" data-key="65">
                            <kbd>A</kbd>
                            <span class="sound">clap</span>
                        </div>
                        <div class="key" data-key="83">
                            <kbd>S</kbd>
                            <span class="sound">hihat</span>
                        </div>
                        <div class="key" data-key="68">
                            <kbd>D</kbd>
                            <span class="sound">kick</span>
                        </div>
                        <div class="key" data-key="70">
                            <kbd>F</kbd>
                            <span class="sound">openhat</span>
                        </div>
                        <div class="key" data-key="71">
                            <kbd>G</kbd>
                            <span class="sound">boom</span>
                        </div>
                        <div class="key" data-key="72">
                            <kbd>H</kbd>
                            <span class="sound">ride</span>
                        </div>
                        <div class="key" data-key="74">
                            <kbd>J</kbd>
                            <span class="sound">snare</span>
                        </div>
                        <div class="key" data-key="75">
                            <kbd>K</kbd>
                            <span class="sound">tom</span>
                        </div>
                        <div class="key" data-key="76">
                            <kbd>L</kbd>
                            <span class="sound">tink</span>
                        </div>
                    </div>
                    <div
                        id="counter"
                        style="
                            background-color: black;
                            color: white;
                            padding: 0.25rem 0.5rem;
                            opacity: 0.5;
                            font-family: monospace;
                            font-size: 0.8rem;
                            border-radius: 0 0 0.5rem 0.5rem;
                            letter-spacing: 0.05em;
                        "
                    >
                        &nbsp;
                    </div>
                </div>
                <div id="track" data-mega-step="9">
                    <div id="beats"></div>
                    <div id="playhead"></div>
                    <div id="beat-icons"></div>
                    <div id="marquis"></div>
                </div>
                <section id="help">
                    <ul>
                        <li><kbd>R</kbd> - record</li>
                        <li><kbd>Spacebar</kbd> - play</li>
                        <li><kbd>Q</kbd> - quantize (nearest beat)</li>
                        <li><kbd>E</kbd> - edit</li>
                        <li><kbd>X</kbd> - clear track</li>
                    </ul>
                    <div class="close">x</div>
                </section>
            </main>
            <footer>from Wes Bos JS30 exercise 1</footer>

            <!-- Sounds -->
            <audio data-key="65" src="./sounds/clap.wav"></audio>
            <audio data-key="83" src="./sounds/hihat.wav"></audio>
            <audio data-key="68" src="./sounds/kick.wav"></audio>
            <audio data-key="70" src="./sounds/openhat.wav"></audio>
            <audio data-key="71" src="./sounds/boom.wav"></audio>
            <audio data-key="72" src="./sounds/ride.wav"></audio>
            <audio data-key="74" src="./sounds/snare.wav"></audio>
            <audio data-key="75" src="./sounds/tom.wav"></audio>
            <audio data-key="76" src="./sounds/tink.wav"></audio>
            <audio id="tick" src="./sounds/metronone-tick.wav"></audio>
        </div>
        <script>
            /*

d8888b. d8888b. db    db .88b  d88.      .88b  d88.  .d8b.   .o88b. db   db d888888b d8b   db d88888b 
88  `8D 88  `8D 88    88 88'YbdP`88      88'YbdP`88 d8' `8b d8P  Y8 88   88   `88'   888o  88 88'     
88   88 88oobY' 88    88 88  88  88      88  88  88 88ooo88 8P      88ooo88    88    88V8o 88 88ooooo 
88   88 88`8b   88    88 88  88  88      88  88  88 88~~~88 8b      88~~~88    88    88 V8o88 88~~~~~ 
88  .8D 88 `88. 88b  d88 88  88  88      88  88  88 88   88 Y8b  d8 88   88   .88.   88  V888 88.     
Y8888D' 88   YD ~Y8888P' YP  YP  YP      YP  YP  YP YP   YP  `Y88P' YP   YP Y888888P VP   V8P Y88888P

            */
            // ======================
            //   DRUM MACHINE
            // ======================
            let bpm = 120;
            let msPerBeat = 60000 / bpm;
            let startTime = -1;
            let elapsed;
            let measures = 2;
            let isPlaying = false;
            let currentMeasure = 0;
            let currentBeat = 0;
            let currentMS = 0;
            // change "song" to "track"
            const song = [];
            const songQuantized = [];
            let quantizeOn = false;
            let isRecording = false;
            let scrubbing = false;
            let draggingIcons = false;
            let lastIconDragX;
            let draggingPlayhead = false;
            let isEditing = false;

            const playhead = document.getElementById("playhead");
            const track = document.getElementById("track");
            track.marquis = track.querySelector("#marquis");
            const beatIcons = document.getElementById("beat-icons");
            const tempoSlider = document.getElementById("tempo-slider");
            const measureSlider = document.getElementById("measures-slider");

            // -------------------------------
            // Initial draw of Track
            // -------------------------------
            const buildTrack = () => {
                playhead.style.left = 0;
                track.trackWidth = document.body.offsetWidth;
                track.duration = msPerBeat * 4 * measures;
                drawTrack();
            };

            const drawTrack = () => {
                const total8ths = measures * 8;
                const pxPer8th = track.trackWidth / total8ths;
                const beatsHolder = document.querySelector("#track #beats");
                beatsHolder.innerHTML = "";
                for (
                    let eighthIndex = 0;
                    eighthIndex < total8ths + 1;
                    eighthIndex++
                ) {
                    // make a new eighth-note line
                    const eighthLine = document.createElement("div");
                    eighthLine.classList.add("beat-line");
                    // if it's an up-beat, make it lighter
                    if (eighthIndex % 2 == 1) {
                        eighthLine.classList.add("up-beat");
                    }
                    eighthLine.style.left = `${pxPer8th * eighthIndex}px`;
                    beatsHolder.appendChild(eighthLine);
                }
            };

            drawTrack();

            const toggleHelp = () => {
                document.getElementById("help").classList.toggle("on");
            };
            const setTempo = (value) => {
                bpm = value;
                msPerBeat = 60000 / bpm;
                track.duration = msPerBeat * 4 * measures;
                drawTrack();
                positionBeatIcons();
                movePlayhead();
            };

            const setMeasures = (value) => {
                measures = value;
                track.duration = msPerBeat * 4 * measures;
                drawTrack();
                positionBeatIcons();
            };

            const movePlayhead = () => {
                const pctPlayed = elapsed / track.duration;
                playhead.style.left = `${track.trackWidth * pctPlayed}px`;
                // console.log(track.trackWidth * pctPlayed);
            };

            const drumClips = Array.from(
                document.querySelectorAll("audio[data-key]")
            );

            const playSound = (audio) => {
                audio.currentTime = 0;
                audio.play();
            };

            const checkSound = (event) => {
                // handles instrument key down
                const audio = document.querySelector(
                    `audio[data-key="${event.keyCode}"]`
                );
                if (audio) {
                    // If recording, record note
                    if (isRecording || isEditing) {
                        programNote(
                            audio,
                            currentMeasure,
                            currentBeat,
                            currentMS
                        );
                    }
                    if (!isPlaying) {
                        // play note
                        const key = document.querySelector(
                            `.key[data-key="${event.keyCode}"]`
                        );

                        playSound(audio);
                        key.classList.add("playing");
                    }
                }
            };

            const removeTransition = (event) => {
                // Remove .key transition
                if (event.target.classList.contains("playing")) {
                    event.target.classList.remove("playing");
                    // console.log("remove Playing - ", event.propertyName);
                }
            };

            // Beat Light
            const showBeat = () => {
                const beatLight = document.getElementById("beat-light");
                if (getComputedStyle(beatLight).height !== "1.5rem") {
                    beatLight.classList.add("on");
                    if (
                        getComputedStyle(playhead).width !== "2px" &&
                        !playhead.classList.contains("on") &&
                        !scrubbing
                    ) {
                        playhead.classList.add("on");
                    }
                }
            };
            document
                .getElementById("beat-light")
                .addEventListener("transitionend", (event) => {
                    if (event.target.classList.contains("on")) {
                        event.target.classList.remove("on");
                    }
                });
            document
                .getElementById("playhead")
                .addEventListener("transitionend", (event) => {
                    if (event.target.classList.contains("on")) {
                        event.target.classList.remove("on");
                    }
                });

            // =============================================
            //   DRUM MACHINE
            // =============================================

            const positionBeatIcon = (note) => {
                // console.log("position beat icon note", note);
                if (!note.beatIcon) return;
                // x position
                const totalBeats = note.measure * 4 + note.beat + note.fraction;
                const pxPerBeat = track.trackWidth / (measures * 4);
                // const pixelsPerMS = track.trackWidth / track.duration;
                // const x = totalMS * pixelsPerMS;
                const x = totalBeats * pxPerBeat;
                // y position
                const drumIndex = drumClips.indexOf(note.audio);
                const y =
                    (drumIndex + 1) *
                    (track.offsetHeight / (drumClips.length + 1));

                note.beatIcon.style.left = x + "px";
                note.beatIcon.style.top = y + "px";
            };

            const makeBeatIcon = () => {
                const icon = document.createElement("div");
                icon.classList.add("beat-icon");

                icon.addEventListener("transitionend", (event) => {
                    if (event.target.classList.contains("on")) {
                        event.target.classList.remove("on");
                    }
                });

                icon.addEventListener("pointerdown", (event) => {
                    // Drag all selected icons
                    if (icon.classList.contains("selected")) {
                        draggingIcons = true;
                        lastIconDragX = getXinTrack(event);
                        console.log("icon.startX", icon.offsetLeft);
                    }
                    event.stopPropagation();
                });
                icon.addEventListener("pointerup", (event) => {
                    // event.currentTarget.classList.toggle("selected");
                    // track.toggleSelectBeat(event.currentTarget);
                    // draggingIcons = false;
                    // event.currentTarget.classList.add("selected");
                    if (isEditing || isRecording) {
                        track.selectBeat(icon);
                    }

                    // if(icon.classList.contains("selected")){

                    // }){

                    // }
                    // event.stopPropagation();
                });

                beatIcons.appendChild(icon);
                return icon;
            };

            const positionBeatIcons = () => {
                const songAr = quantizeOn ? songQuantized : song;
                for (const measure of songAr) {
                    if (measure) {
                        for (const beat of measure) {
                            if (beat) {
                                for (const note of beat) {
                                    positionBeatIcon(note);
                                }
                            }
                        }
                    }
                }
            };

            const programNote = (audio, measure, beat, ms) => {
                // console.log(
                //     `programNote(${audio.src},${measure},${beat},${ms})`
                // );
                // console.log("msPerBeat", msPerBeat);
                let beatIcon = null;
                if (audio.id != "tick") {
                    beatIcon = makeBeatIcon();
                }
                if (!song[measure]) song[measure] = [];
                if (!song[measure][beat]) song[measure][beat] = [];
                const note = {
                    audio,
                    beatIcon,
                    measure,
                    beat,
                    fraction: ms / msPerBeat,
                };
                // console.log("note", note);
                song[measure][beat].push(note);
                const qNote = quantizeNote(note);
                addNoteToSongQuantized(qNote);
                if (quantizeOn) {
                    positionBeatIcon(qNote);
                } else {
                    positionBeatIcon(note);
                }
                beatIcon.note = note;
                beatIcon.qNote = qNote;
            };

            const getNoteList = (measure, beat) => {
                // console.log("getNoteList: ", measure, beat);
                // console.log("song: ", song);
                const songAr = quantizeOn ? songQuantized : song;
                if (!songAr[measure]) return [];
                if (!songAr[measure][beat]) return [];
                // console.log(songAr[measure][beat].length)r
                return songAr[measure][beat];
            };

            const getNextBeat = (measureNum, beatNum) => {
                // console.log("getNextBeat()");
                const newBeat = (measureNum * 4 + beatNum + 1) % (measures * 4);
                const nextMeasure = Math.floor(newBeat / 4);
                const nextBeat = newBeat - nextMeasure * 4;
                // console.log("from", measureNum, beatNum);
                // console.log("to: ", nextMeasure, nextBeat);
                return {
                    measure: nextMeasure,
                    beat: nextBeat,
                };
            };

            const toggleQuantize = () => {
                console.log("toggleQuantize()");
                if (quantizeOn) {
                    quantizeOn = false;
                } else {
                    quantizeOn = true;
                }
                document
                    .getElementById("quantize-light")
                    .classList.toggle("on");
                positionBeatIcons();
            };

            const addNoteToSongQuantized = (note) => {
                if (!songQuantized[note.measure])
                    songQuantized[note.measure] = [];
                if (!songQuantized[note.measure][note.beat])
                    songQuantized[note.measure][note.beat] = [];
                songQuantized[note.measure][note.beat].push(note);
            };

            const quantizeNote = (note) => {
                // console.log("quantize note", note);
                let noteMeasure = note.measure;
                let noteBeat = note.beat;
                let fraction = note.fraction;
                let qFraction;
                // round

                // one8th is half beat
                const one8th = 0.5;
                if (fraction > one8th) {
                    // console.log("2nd 8th");
                    // 2nd 8th
                    qFraction =
                        one8th +
                        Math.round((fraction - one8th) / one8th) * one8th;
                    if (qFraction === 1) {
                        // End of beat, put at start of next beat
                        // console.log("start: ", noteMeasure, noteBeat, fraction);
                        const nextBeatObj = getNextBeat(noteMeasure, noteBeat);
                        noteMeasure = nextBeatObj.measure;
                        noteBeat = nextBeatObj.beat;
                        qFraction = 0;
                        // console.log("end: ", noteMeasure, noteBeat, qFraction);
                    }
                } else {
                    // first 8th
                    // console.log("first 8th");
                    qFraction = Math.round(fraction / one8th) * one8th;
                }

                const quantizedNote = {
                    audio: note.audio,
                    beatIcon: note.beatIcon,
                    measure: noteMeasure,
                    beat: noteBeat,
                    fraction: qFraction,
                };
                // console.log("quantized note: ", quantizedNote);
                return quantizedNote;
            };

            const quantizeTrack = () => {
                // move all 'notes' to closest 8th
                songQuantized.length = 0;
                for (const measure of song) {
                    if (measure) {
                        for (const beat of measure) {
                            if (beat) {
                                for (const note of beat) {
                                    const quantizedNote = quantizeNote(note);
                                    addNoteToSongQuantized(quantizedNote);
                                }
                            }
                        }
                    }
                }
                // console.log("songQuantized", songQuantized);
            };

            const getNoteFromBeatIcon = (beatIcon) => {
                // or we can just set beatIcon.note when we create an icon
                for (const measure of song) {
                    if (measure) {
                        for (const beat of measure) {
                            if (beat) {
                                for (const note of beat) {
                                    if (note.beatIcon === beatIcon) {
                                        return note;
                                    }
                                }
                            }
                        }
                    }
                }
                // console.log("songQuantized", songQuantized);
            };

            const positionNoteFromIcon = (beatIcon) => {
                console.log("positionNoteFromIcon()");
                console.log(beatIcon);
                // if (beatIcon.note) {
                const note = beatIcon.note; // getNoteFromBeatIcon(beatIcon);

                // }
                console.log("beatIcon.offsetLeft", beatIcon.offsetLeft);
                console.log("icon rect", beatIcon.getBoundingClientRect());
                const pctPos = beatIcon.offsetLeft / track.trackWidth;
                const elapsed = pctPos * track.duration;
                console.log("elapsed", elapsed);
                const beats = Math.floor(elapsed / msPerBeat);
                const measure = Math.floor(beats / 4);
                const beat = beats - measure * 4;
                const ms = elapsed - beats * msPerBeat;
                // remove note from current place in song
                removeNoteFromSong(note);
                programNote(note.audio, measure, beat, ms);
            };

            const removeNoteFromSong = (note) => {
                console.log("removeNoteFromSong()");
                let icon = note.beatIcon;
                let beat = song[note.measure][note.beat];
                let noteIndex = beat.indexOf(note);

                if (noteIndex !== -1) {
                    beat.splice(noteIndex, 1);
                }
                // quantized note
                beat = songQuantized[note.measure][note.beat];
                if (beat) {
                    const qNote = beat.find(
                        (qn) => qn.beatIcon === note.beatIcon
                    );

                    if (qNote) {
                        noteIndex = beat.indexOf(qNote);
                        beat.splice(noteIndex, 1);
                    }
                }

                icon.remove();
            };

            const clearTrack = () => {
                // // clear all the beat icons
                // beatIcons.innerHTML = "";
                // //
                // song.length = songQuantized.length = 0;

                clearLight.classList.add("on");

                // clear selected beat icons
                const selectedIcons = Array.from(
                    beatIcons.querySelectorAll(".beat-icon.selected")
                );
                // console.log("selectedIcons: ", selectedIcons);

                for (const icon of selectedIcons) {
                    // find its note in the song
                    // const note = icon.note; //getNoteFromBeatIcon(icon);
                    removeNoteFromSong(icon.note);
                }
            };
            const checkAndPlayNotes = (measure, beat, f0, f1) => {
                // While track is playing
                const notesList = getNoteList(measure, beat);
                // if (notesList.length > 0) console.log("notesList: ", notesList);
                notesList.forEach((note) => {
                    if (note.fraction >= f0 && note.fraction < f1) {
                        // play it
                        playSound(note.audio);
                        // light it up
                        const code = note.audio.getAttribute("data-key");
                        const key = document.querySelector(
                            `.key[data-key="${code}"]`
                        );
                        const keyStyle = getComputedStyle(key);

                        if (keyStyle.borderRadius !== "1px") {
                            key.classList.add("playing");
                        }

                        if (note.beatIcon) {
                            note.beatIcon.classList.add("on");
                        }
                    }
                });
            };

            const startPlaying = () => {
                // console.log("startPlaying()");
                isPlaying = true;
                startTime = -1;
                window.requestAnimationFrame(step);
            };

            /*

                                                                                                  
 ad88888ba                                     88                                                 
d8"     "8b  ,d                                88                                                 
Y8,          88                                88                                                 
`Y8aaaaa,  MM88MMM  ,adPPYba,  8b,dPPYba,      88           ,adPPYba,    ,adPPYba,   8b,dPPYba,   
  `"""""8b,  88    a8P_____88  88P'    "8a     88          a8"     "8a  a8"     "8a  88P'    "8a  
        `8b  88    8PP"""""""  88       d8     88          8b       d8  8b       d8  88       d8  
Y8a     a8P  88,   "8b,   ,aa  88b,   ,a8"     88          "8a,   ,a8"  "8a,   ,a8"  88b,   ,a8"  
 "Y88888P"   "Y888  `"Ybbd8"'  88`YbbdP"'      88888888888  `"YbbdP"'    `"YbbdP"'   88`YbbdP"'   
                               88                                                    88           
                               88                                                    88  


            */
            function step(timestamp) {
                if (startTime === -1) startTime = timestamp;
                elapsed = timestamp - startTime;
                movePlayhead();
                const lastMeasure = currentMeasure;
                currentMeasure =
                    Math.floor(elapsed / (msPerBeat * 4)) % measures;
                const lastBeat = currentBeat;
                currentBeat = Math.floor(elapsed / msPerBeat) % 4;
                const lastMS = currentMS;
                currentMS = Math.floor(elapsed % msPerBeat);
                const f0 = lastMS / msPerBeat;
                const f1 = currentMS / msPerBeat;
                // check for new beat
                if (currentBeat != lastBeat || elapsed === 0) {
                    // console.log("beat!");
                    // On New Beat!
                    if (isRecording) {
                        playSound(document.getElementById("tick"));
                    }
                    showBeat();
                    // have we played through the track and started over?
                    if (currentMeasure === 0 && currentBeat === 0) {
                        elapsed = timestamp;
                        startTime = timestamp - currentMS;
                    }

                    // end of last beat
                    checkAndPlayNotes(lastMeasure, lastBeat, f0, 1);
                    // start of this beat
                    checkAndPlayNotes(currentMeasure, currentBeat, 0, f1);
                } else {
                    // this beat only
                    checkAndPlayNotes(currentMeasure, currentBeat, f0, f1);
                }

                document.getElementById(
                    "counter"
                ).innerHTML = `measure ${currentMeasure}
                beat ${currentBeat}
                ms ${currentMS}`;

                if (isPlaying) {
                    window.requestAnimationFrame(step);
                }
            }

            const getXinTrack = (pointerevent) => {
                const clientX = pointerevent.clientX;
                const trackX = track.getBoundingClientRect().left;
                return clientX - trackX;
            };

            // =======================
            //   RECORDING
            // =======================
            const startRecording = () => {
                document.getElementById("rec-light").classList.add("on");
                isRecording = true;
                quantizeTrack();
                startPlaying();
            };
            const stopRecording = () => {
                document.getElementById("rec-light").classList.remove("on");
                isRecording = false;
                quantizeTrack();
            };
            const toggleRecording = () => {
                isRecording = !isRecording;
                if (isRecording) {
                    startRecording();
                } else {
                    stopRecording();
                }
            };

            const toggleEdit = () => {
                console.log("toggleEdit()");
                isEditing = !isEditing;
                document.getElementById("edit-light").classList.toggle("on");
                if (!isEditing) {
                    // Deselect all icons
                    track.deselectBeats();
                }
            };

            /*

 .o88b.  .d88b.  d8b   db d888888b d8888b.  .d88b.  db      .d8888. 
d8P  Y8 .8P  Y8. 888o  88 `~~88~~' 88  `8D .8P  Y8. 88      88'  YP 
8P      88    88 88V8o 88    88    88oobY' 88    88 88      `8bo.   
8b      88    88 88 V8o88    88    88`8b   88    88 88        `Y8b. 
Y8b  d8 `8b  d8' 88  V888    88    88 `88. `8b  d8' 88booo. db   8D 
 `Y88P'  `Y88P'  VP   V8P    YP    88   YD  `Y88P'  Y88888P `8888Y' 
                                                                                                                

            */
            // =======================
            //   CONTROLS
            // =======================

            const keys = document.querySelectorAll(".key");
            keys.forEach((key) => {
                // flag to prevent keydown from firing endlessly
                // key.setAttribute("data-is-down", "false");
                // when the css transition is done, remove the class
                key.addEventListener("transitionend", (event) => {
                    // console.log(event.propertyName);
                    if (event.propertyName === "border-top-color") {
                        removeTransition(event);
                    }
                });
                // key.addEventListener("transitionstart", (event) => {
                //     // console.log(event.propertyName);
                //     if (event.propertyName === "border-top-color") {
                //         console.log(
                //             "transitionstart",
                //             key.getAttribute("data-key")
                //         );
                //     }
                // });
            });

            const keysDown = [];

            const clearLight = document.getElementById("clear-light");

            clearLight.addEventListener("transitionend", (event) => {
                if (event.target.classList.contains("on")) {
                    event.target.classList.remove("on");
                }
            });

            tempoSlider.addEventListener("input", (event) => {
                // change tempo number display
                const valueDisplay =
                    document.querySelector(".info.tempo .value");
                const oldvalue = bpm;
                const value = Number(event.target.value);
                valueDisplay.innerHTML = value;

                if (Math.abs(value - oldvalue) > 20) {
                    setTempo(value);
                }
            });
            tempoSlider.addEventListener("change", (event) => {
                // set tempo
                const value = event.target.value;
                document.querySelector(".info.tempo .value").innerHTML = value;
                setTempo(value);
            });
            tempoSlider.addEventListener("pointerdown", (event) => {
                scrubbing = true;
            });
            tempoSlider.addEventListener("pointerup", (event) => {
                scrubbing = false;
            });
            measureSlider.addEventListener("input", (event) => {
                const value = event.target.value;
                document.querySelector(".info.measure .value").innerHTML =
                    value;
                setMeasures(value);
            });

            // Press Key
            // window.addEventListener("keydown", checkSound);
            // Key Up
            // window.addEventListener("keyup", handleKeyUp);

            window.addEventListener("keydown", (event) => {
                if (keysDown.includes(event.keyCode)) {
                    // key is already down
                    return;
                } else {
                    keysDown.push(event.keyCode);
                }
                if (event.keyCode === 82) {
                    // 'R'
                    // record
                    toggleRecording();
                } else if (event.keyCode === 88 || event.keyCode === 8) {
                    // 'X' or Backspace
                    // clear note/s
                    clearTrack();
                } else if (event.keyCode === 81) {
                    // 'Q'
                    // quantize
                    toggleQuantize();
                } else if (event.keyCode === 32) {
                    // Spacebar
                    if (!isPlaying) {
                        startPlaying();
                    } else {
                        isPlaying = false;
                        stopRecording();
                        playhead.classList.remove("on");
                    }
                } else if (event.keyCode === 69) {
                    // 'E'
                    // edit
                    toggleEdit();
                    // } else if (event.keyCode === 191) {
                    //     // '?'
                    //     // help
                    //     toggleHelp();
                } else {
                    // Maybe an instrument key
                    checkSound(event);
                }
            });

            document
                .getElementById("help-icon")
                .addEventListener("pointerdown", (event) => {
                    toggleHelp();
                });

            window.addEventListener("keyup", (event) => {
                const keyIndex = keysDown.indexOf(event.keyCode);
                if (keyIndex !== -1) {
                    keysDown.splice(keyIndex, 1);
                }
            });

            ////////////////////
            // Edit Beats
            ////////////////////

            track.selectBeat = (beatIcon) => {
                // console.log('selectBeat', beatIcon);
                if (!beatIcon.classList.contains("selected")) {
                    beatIcon.classList.add("selected");
                    playSound(beatIcon.note.audio);
                }
            };
            track.deselectBeat = (beatIcon) => {
                beatIcon.classList.remove("selected");
            };
            track.deselectBeats = () => {
                // deselect all beat icons
                let beatIcons = Array.from(
                    document.querySelectorAll("#beat-icons .beat-icon")
                );
                for (const beatIcon of beatIcons) {
                    track.deselectBeat(beatIcon);
                }
            };
            track.toggleSelectBeat = (beatIcon) => {
                if (beatIcon.classList.contains("selected")) {
                    track.deselectBeat(beatIcon);
                } else {
                    track.selectBeat(beatIcon);
                }
            };
            track.marquisBeats = (start, end) => {
                const minX = Math.min(start.x, end.x),
                    maxX = Math.max(start.x, end.x),
                    minY = Math.min(start.y, end.y),
                    maxY = Math.max(start.y, end.y);

                let beatIcons = Array.from(
                    document.querySelectorAll("#beat-icons .beat-icon")
                );

                for (const beatIcon of beatIcons) {
                    // inside marquis?
                    const trackRect = track.getBoundingClientRect(),
                        iconRect = beatIcon.getBoundingClientRect(),
                        x = iconRect.left - trackRect.left,
                        y = iconRect.top - trackRect.top;
                    if (x >= minX && x <= maxX && y >= minY && y <= maxY) {
                        // Beat is inside marquis
                        track.selectBeat(beatIcon);
                    } else {
                        track.deselectBeat(beatIcon);
                    }
                    // console.log("note", beatIcon.note);
                }
            };
            track.drawMarquis = (start, end) => {
                const minX = Math.min(start.x, end.x),
                    maxX = Math.max(start.x, end.x),
                    minY = Math.min(start.y, end.y),
                    maxY = Math.max(start.y, end.y);

                track.marquis.style.left = minX + "px";
                track.marquis.style.top = minY + "px";
                track.marquis.style.width = maxX - minX + "px";
                track.marquis.style.height = maxY - minY + "px";
                // console.log(maxX, ",", maxY);
            };

            track.addEventListener("pointerdown", (event) => {
                console.log("click track");
                if (draggingPlayhead || !isEditing) return;
                track.pointerdown = true;

                // Get the bounding rectangle of target
                const rect = event.currentTarget.getBoundingClientRect();

                // Mouse position
                const x = event.clientX - rect.left;
                const y = event.clientY - rect.top;

                track.startXY = { x, y };
                track.marquis.classList.add("on");
                track.drawMarquis({ x, y }, { x, y });
            });
            track.addEventListener("pointerup", (event) => {
                // console.log("click track");
                if (!track.marquis.classList.contains("on")) return;
                track.pointerdown = false;
                track.marquis.classList.remove("on");

                // Get the bounding rectangle of target
                const rect = event.currentTarget.getBoundingClientRect();

                // Mouse position
                const x = event.clientX - rect.left;
                const y = event.clientY - rect.top;

                track.marquisBeats(track.startXY, { x, y });

                // remove marquis
            });

            track.addEventListener("pointermove", (event) => {
                if (track.pointerdown) {
                    // Get the bounding rectangle of target
                    const rect = event.currentTarget.getBoundingClientRect();

                    // Mouse position
                    const x = event.clientX - rect.left;
                    const y = event.clientY - rect.top;
                    // console.log(x, y);

                    // draw marquis
                    track.drawMarquis(track.startXY, { x, y });
                    track.marquisBeats(track.startXY, { x, y });
                }
            });
            const setPlayheadPosition = (playheadX) => {
                playhead.style.left = playheadX + "px";
                const pctPos = playheadX / track.trackWidth;
                const elapsed = pctPos * track.duration;
                const beats = Math.floor(elapsed / msPerBeat);
                currentMeasure = Math.floor(beats / 4);
                currentBeat = beats - currentMeasure * 4;
                currentMS = elapsed - beats * msPerBeat;
            };

            // Drag Playhead
            playhead.addEventListener("pointerdown", (event) => {
                // console.log("Mouse Down on Playhead");
                draggingPlayhead = true;
            });

            document.body.addEventListener("pointermove", (event) => {
                if (draggingPlayhead) {
                    // console.log("dragging playhead");
                    // get mouse x relative to Track
                    const clientX = event.clientX;
                    const trackX = track.getBoundingClientRect().left;
                    const playheadX = clientX - trackX;

                    setPlayheadPosition(playheadX);
                    // console.log(playheadX + "px");
                } else if (draggingIcons) {
                    // Drag Icons
                    const newIconDragX = getXinTrack(event);
                    const dragDistX = event.movementX; //newIconDragX - lastIconDragX; //
                    const selectedIcons = Array.from(
                        beatIcons.querySelectorAll(".beat-icon.selected")
                    );
                    for (icon of selectedIcons) {
                        icon.style.left = `${icon.offsetLeft + dragDistX}px`;
                    }
                    lastIconDragX = newIconDragX;
                }
            });
            document.body.addEventListener("pointerup", (event) => {
                // console.log("Release Playhead");

                draggingPlayhead = false;
                if (draggingIcons) {
                    // reset notes of selected icons
                    const selectedIcons = Array.from(
                        beatIcons.querySelectorAll(".beat-icon.selected")
                    );
                    // console.log('selectedIcons',selectedIcons)
                    for (icon of selectedIcons) {
                        icon.classList.remove("selected");
                        positionNoteFromIcon(icon);
                    }

                    draggingIcons = false;
                }
            });

            document
                .querySelector("#help .close")
                .addEventListener("pointerdown", (event) => {
                    toggleHelp();
                });

            buildTrack();

            /*

888888888888                             88                            
     88                           ,d     ""                            
     88                           88                                   
     88   ,adPPYba,  ,adPPYba,  MM88MMM  88  8b,dPPYba,    ,adPPYb,d8  
     88  a8P_____88  I8[    ""    88     88  88P'   `"8a  a8"    `Y88  
     88  8PP"""""""   `"Y8ba,     88     88  88       88  8b       88  
     88  "8b,   ,aa  aa    ]8I    88,    88  88       88  "8a,   ,d88  
     88   `"Ybbd8"'  `"YbbdP"'    "Y888  88  88       88   `"YbbdP"Y8  
                                                           aa,    ,88  
                                                            "Y8bbdP"   


*/

            // TESTING V

            const light = document.getElementById("beat-light");
            window.addEventListener("keydown", (event) => {
                if (event.keyCode === 84) {
                    // 'T' (testing)
                    if (!keysDown.includes(84)) {
                        keysDown.push(84);
                        light.classList.add("on");
                    }
                }
            });
            window.addEventListener("keyup", (event) => {
                if (event.keyCode === 84 && keysDown.includes(84)) {
                    // 'T'
                    keysDown.splice(keysDown.indexOf(84), 1);
                }
            });
            light.addEventListener("transitionend", (event) => {
                if (event.propertyName === "box-shadow") {
                    // console.log(
                    //     "light transitionend - ison: ",
                    //     event.target.classList.contains("on")
                    // );
                    if (
                        event.target.classList.contains("on") &&
                        event.elapsedTime >= 0.02
                    ) {
                        console.log("!!!!! - ", event.elapsedTime);
                        console.log(event);
                    }
                    // console.log(event);
                }
            });
            light.addEventListener("transitionstart", (event) => {
                if (event.propertyName === "box-shadow") {
                    if (event.elapsedTime >= 0.02) {
                        console.log(
                            "light transitionstart - ison: ",
                            event.target.classList.contains("on")
                        );

                        console.log("!!!!! - ", event.elapsedTime);
                    }
                    // console.log(event);
                }
            });

            // window.addEventListener("keyup", (event) => {
            //     if (event.keyCode === 84) {
            //         // 'T'
            //         const light = document.getElementById("beat-light");
            //         light.setAttribute("data-on", "false");
            //     }
            // });
            // const Tkey = document.getElementById("beat-light");
            // // document.querySelector(`.key[data-key="${74}"]`);
            // Tkey.addEventListener("transitionend", (event) => {
            //     console.log("transition end", event.target);
            // });
            // Tkey.addEventListener("transitionstart", (event) => {
            //     console.log("transition start", event.target);
            //     console.log('prop: ',event.propertyName);
            // });
            // const light = document.getElementById("quantize-light");
            // light.classList.add("on");
            // light.classList.add("on");
            // light.classList.add("on");
        </script>

        <script src="./mega-walkthrough/mega-walkthrough.js"></script>
        <script>
            megaWalkthrough.setCopy([
                ["Help", "Press '?' to toggle Help."],
                [
                    "Drum Pad",
                    "Each sample corresponds to a key on the keyboard.",
                ],
                [
                    "Beat Light",
                    "This flashes on the beat while the track is playing or recording.",
                ],
                [
                    "Record Light",
                    "Press 'R' to toggle recording.  Press sample keys while recording to add them to the track.",
                ],
                ["Cut", "Press 'X' (or backspace) to remove selected notes."],
                [
                    "Quantize",
                    "Press 'Q' to toggle quantize mode. This snaps notes to the closest beat",
                ],
                [
                    "Edit Light",
                    "Press 'E' to toggle Edit mode.  In edit mode, you can select, move and delete notes.",
                ],
                ["Tempo", "Drag slider to set beats-per-minute."],
                [
                    "Measures",
                    "Drag slider to set number of measures in your track.",
                ],
                [
                    "Track",
                    "Recorded notes are displayed here. Select, move and cut notes while Edit or Record mode are on.",
                ],
            ]);
            // Change 'steps' to object format:
            /*
    [
        {
            title: "Some Title",
            copy: "Some Copy",
            querySelector: [query selector to target the element],
            eventTrigger: [event to trigger on this element - can be left out]
        },
        {
            title: "Some Title",
            copy: "Some Copy",
            querySelector: [query selector to target the element],
            eventTrigger: [event to trigger on this element - can be left out]
        },
    ]
    */
            // megaWalkthrough.show();
            setTimeout(() => {
                // Give time for Help (?) to get positioned
                megaWalkthrough.start();
            }, 2000);
            window.addEventListener("keydown", (event) => {
                if (event.keyCode === 191) {
                    // '?'
                    // help
                    megaWalkthrough.toggle();
                    event.stopPropagation();
                    event.preventDefault();
                }
            });
        </script>
    </body>
</html>
